<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Επεξεργασία Προσώπου - Προσθήκη Χαμόγελου</title>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; color: #1c1e21; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { background-color: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0, 0, 0, .15); width: 100%; max-width: 1000px; text-align: center; margin-bottom: 25px; }
        h1, h2 { color: #0d6efd; }
        nav { background-color: #fff; padding: 15px 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, .1); margin-bottom: 20px; width: 100%; max-width: 1000px; display: flex; align-items: center; }
        nav a { text-decoration: none; color: #0d6efd; font-weight: 700; font-size: 1.2em; }
        button { background-color: #0d6efd; color: #fff; border: none; padding: 10px 18px; border-radius: 5px; font-size: 1em; cursor: pointer; transition: background-color .3s; }
        button:hover { background-color: #0a58ca; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; opacity: 0.65; }
        input[type="file"] { margin-bottom: 15px; }
        #main-content { display: flex; justify-content: space-around; flex-wrap: wrap; gap: 20px; margin-top: 20px; }
        #image-display-area { display: flex; justify-content: center; gap: 20px; width: 100%;}
        #image-display-area canvas, #image-display-area img { max-width: 100%; width: 400px; height: auto; display: block; border: 1px solid #ddd; }
        #controls-area { width: 100%; max-width: 400px; margin-top: 20px; padding: 20px; background: #f9f9f9; border-radius: 8px;}
        .slider-group { margin-bottom: 15px; text-align: left;}
        .slider-group label { display: block; margin-bottom: 5px; font-weight: 500;}
    </style>
</head>
<body>

    <nav>
        <a href="index.html">❮ Επιστροφή στην Αρχική</a>
    </nav>

    <div class="container" id="face-editor-container">
        <h1>Επεξεργασία Προσώπου</h1>
        <h2>Προσθήκη Χαμόγελου (Beta)</h2>
        <p id="loading-models-message">Φόρτωση τοπικών μοντέλων AI... Παρακαλώ περιμένετε.</p>
        
        <div id="upload-controls" style="display: none;">
            <p>Ανεβάστε μια φωτογραφία που περιέχει ένα καθαρό πρόσωπο.</p>
            <input type="file" id="face-image-upload" accept="image/*">
        </div>

        <div id="main-content" style="display: none;">
            <div id="image-display-area">
                <div>
                    <h3>Αρχική Εικόνα</h3>
                    <img id="original-face-image" src="" alt="Αρχική Φωτογραφία">
                </div>
                <div>
                    <h3>Αποτέλεσμα</h3>
                    <canvas id="result-canvas"></canvas>
                </div>
            </div>
            <div id="controls-area">
                <h3>Ρυθμίσεις Εφέ</h3>
                <div class="slider-group">
                    <label for="strength-slider">Δύναμη Χαμόγελου: <span id="strength-value">20</span></label>
                    <input type="range" id="strength-slider" min="0" max="100" value="20" style="width: 100%;">
                </div>
                <div class="slider-group">
                    <label for="radius-slider">Ακτίνα Επίδρασης: <span id="radius-value">60</span></label>
                    <input type="range" id="radius-slider" min="10" max="200" value="60" style="width: 100%;">
                </div>
                 <button id="download-button" style="margin-top: 20px;">Λήψη Εικόνας</button>
            </div>
        </div>
        <p id="processing-message" style="display: none;">Εντοπισμός προσώπου...</p>

    </div>

    <script>
        const loadingMessage = document.getElementById('loading-models-message');
        const uploadControls = document.getElementById('upload-controls');
        const faceImageUpload = document.getElementById('face-image-upload');
        const originalFaceImage = document.getElementById('original-face-image');
        const resultCanvas = document.getElementById('result-canvas');
        const mainContent = document.getElementById('main-content');
        const processingMessage = document.getElementById('processing-message');
        const strengthSlider = document.getElementById('strength-slider');
        const radiusSlider = document.getElementById('radius-slider');
        const strengthValue = document.getElementById('strength-value');
        const radiusValue = document.getElementById('radius-value');
        const downloadButton = document.getElementById('download-button');

        let uploadedImage = null;
        let detectedLandmarks = null;

        async function loadModels() {
            const MODEL_URL = './weights'; 
            try {
                await faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL);
                await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
                loadingMessage.style.display = 'none';
                uploadControls.style.display = 'block';
            } catch (error) {
                console.error("Error loading models:", error);
                loadingMessage.innerHTML = "Σφάλμα φόρτωσης των τοπικών μοντέλων. <br>Βεβαιωθείτε ότι ο φάκελος 'weights' είναι δίπλα στο αρχείο `smile_editor.html`.";
            }
        }
        loadModels();

        faceImageUpload.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                uploadedImage = new Image();
                uploadedImage.src = event.target.result;
                uploadedImage.onload = async () => {
                    originalFaceImage.src = event.target.result;
                    mainContent.style.display = 'flex';
                    uploadControls.style.display = 'none';
                    processingMessage.style.display = 'block';

                    const detections = await faceapi.detectSingleFace(uploadedImage, new faceapi.SsdMobilenetv1Options()).withFaceLandmarks();
                    
                    processingMessage.style.display = 'none';

                    if (detections) {
                        detectedLandmarks = detections.landmarks;
                        applySmileWarp(); // Εφαρμογή με τις αρχικές τιμές των sliders
                    } else {
                        alert("Δεν εντοπίστηκε πρόσωπο. Παρακαλώ, επιλέξτε μια άλλη φωτογραφία.");
                        mainContent.style.display = 'none';
                        uploadControls.style.display = 'block';
                    }
                };
            };
            reader.readAsDataURL(file);
        });

        function applySmileWarp() {
            if (!uploadedImage || !detectedLandmarks) return;
            
            const strength = parseInt(strengthSlider.value);
            const radius = parseInt(radiusSlider.value);
            strengthValue.textContent = strength;
            radiusValue.textContent = radius;

            const canvas = resultCanvas;
            const ctx = canvas.getContext('2d');
            canvas.width = uploadedImage.width;
            canvas.height = uploadedImage.height;
            ctx.drawImage(uploadedImage, 0, 0);
            
            const originalImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const warpedImageData = ctx.createImageData(canvas.width, canvas.height);
            warpedImageData.data.set(originalImageData.data);

            const mouth = detectedLandmarks.getMouth();
            const leftCorner = mouth[0];
            const rightCorner = mouth[6];

            const warpPoint = (corner) => {
                for (let y = -radius; y <= radius; y++) {
                    for (let x = -radius; x <= radius; x++) {
                        const currentX = Math.round(corner.x + x);
                        const currentY = Math.round(corner.y + y);
                        const distance = Math.sqrt(x * x + y * y);

                        if (distance <= radius) {
                            const factor = (radius - distance) / radius;
                            const dy = -factor * strength * (1 - (Math.abs(x) / radius));
                            const srcY = Math.round(currentY - dy);

                            if (currentX >= 0 && currentX < canvas.width && srcY >= 0 && srcY < canvas.height) {
                                const destIndex = (currentY * canvas.width + currentX) * 4;
                                const srcIndex = (srcY * canvas.width + currentX) * 4;
                                
                                warpedImageData.data[destIndex]     = originalImageData.data[srcIndex];
                                warpedImageData.data[destIndex + 1] = originalImageData.data[srcIndex + 1];
                                warpedImageData.data[destIndex + 2] = originalImageData.data[srcIndex + 2];
                                warpedImageData.data[destIndex + 3] = originalImageData.data[srcIndex + 3];
                            }
                        }
                    }
                }
            };

            warpPoint(leftCorner);
            warpPoint(rightCorner);
            
            ctx.putImageData(warpedImageData, 0, 0);
        }
        
        // Listeners για τα sliders
        strengthSlider.addEventListener('input', applySmileWarp);
        radiusSlider.addEventListener('input', applySmileWarp);

        // Listener για το κουμπί λήψης
        downloadButton.addEventListener('click', () => {
            if (!uploadedImage) return;
            const link = document.createElement('a');
            link.download = 'smiling_face.png';
            link.href = resultCanvas.toDataURL('image/png');
            link.click();
        });

    </script>

</body>
</html>
